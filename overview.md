# 能见度插值算法

本项目包含两个主要部分：

1. **基于站点湿度和距离的站点能见度估计算法**
2. **格点化的各向异性反距离权重插值算法**

本项目为 Python 实现。

---

## 一、站点能见度估计算法

1. **数据读取与筛选**
   - 使用 `pandas` 读取站点列表（CSV 文件）。
   - 根据是否有能见度数据，分为有能见度的站点（`station_vis`）和无能见度但有相对湿度的站点（`station_rh`）。

2. **最近邻站点匹配**
   - 对于 `station_rh` 中的每个站点，查找 `station_vis` 中距离最近的若干站点，得到最近邻站点列表 `station_nearest` 及其距离 `station_nearest_distance`。

3. **能见度估算**
   - 对 `station_rh`，分别用湿度和距离进行能见度估算，分别记为 `vis_rh` 和 `vis_dis`。

4. **基于相对湿度的能见度估算（vis_rh）**
   - 读取最近邻站点的相对湿度 $rh_i$。
   - 计算本站与各最近邻站点的湿度差 $d\_rh\_i = rh - rh_i$。
   - 计算湿度权重 $w\_rh\_i = 1/(d\_rh\_i)^2$。
   - 加权平均得到 $vis\_rh = \sum(w\_rh\_i \cdot vis_i) / \sum(w\_rh\_i)$。

5. **基于距离的能见度估算（vis_dis）**
   - 读取最近邻站点的经纬度，计算与本站的距离 $distance_i$。
   - 计算距离权重 $w\_dis\_i = 1/(distance_i)^2$。
   - 加权平均得到 $vis\_dis = \sum(w\_dis\_i \cdot vis_i) / \sum(w\_dis\_i)$。

6. **最终能见度估算**
   - 对每个 `station_rh` 站点，最终能见度 $vis = 0.5 \times vis\_rh + 0.5 \times vis\_dis$。

7. **结果合并**
   - 合并 `station_vis` 和 `station_rh`，得到最终表 `station_vis_all`。
   - 添加一列 `is_vis_est`，`station_rh` 中该列为 1，`station_vis` 中为 0，用于区分真实值和估算值。

---

## 二、格点化能见度估计算法

采用各向异性反距离权重法，将站点能见度插值到格点上。

### 各向异性距离函数

为增强垂直方向影响，引入缩放因子 $\beta > 1$（默认 $\beta=10$）：

$$
d_i = \sqrt{(x_i - x_0)^2 + (y_i - y_0)^2 + \beta^2 (z_i - z_0)^2}
$$

- $\beta$：垂直方向权重放大因子
- $d_i$：插值点与观测点的距离
- $x_i, y_i, z_i$：观测点经度、纬度、海拔
- $x_0, y_0, z_0$：插值点经度、纬度、海拔

> **注意：经纬度需换算为欧氏距离。**

距离权重计算公式：

$$
w_i = \frac{1}{d_i^p}
$$

- $p$：权重幂次，控制衰减速度，默认 $p=2$

使用 `xarray` 创建指定范围的 $0.01^\circ$ 经纬度分辨率网格，按上述方法插值。

---

## 三、站点文件格式说明

站点文件为 CSV 格式，需读取以下字段：

| 中文         | 字段        | 英文名    |
|--------------|-------------|-----------|
| 站号         | V01301      | code      |
| 站点名称     | VF01015_CN  | name      |
| 所属地市     | V_CITY      | city      |
| 所属县       | V_COUNTY    | county    |
| 站点经度     | V06001      | lon       |
| 站点纬度     | V05001      | lat       |
| 站点海拔高度 | V07001      | altitude  |
| 站点能见度   | V20001      | vis       |
| 相对湿度     | V13003      | rh        |

> 用 `pandas` 读取相应字段，并重命名为上表中的英文名。

---

## 四、高程数据说明

高程数据文件名格式如下：
ASTGTM2_NyyExxx_dem.tif, 其中yy为纬度，xxx为经度，例如：
ASTGTM2_N25E114_dem.tif, 表示25°N, 114°E的高程数据。